<?php
/**
 * Fundraisers end point model.
 * Model holds the validation rules for fundraisers end point.
 *
 * @package: Framework\Model
 * @author: Kris Pomphrey <kris@krispomphrey.co.uk>
 */
class FundraisersModel extends Model{
  /**
  * Variable that will hold the DB connection.
  * @var array
  */
  public $models = array('Error');

  /**
  * Variable that holds the api area being called.
  * @var string
  */
  public $area;

  /**
  * Variable that will hold all errors returned by the model.
  * @var array
  */
  public $errors = array();

  /**
   * Implements init();
   *
   * Initialise the Fundraisers Model.
   */
  public function init(){ }

  /**
   * Implements validate();
   *
   * Custom validation function that checks data integrity, pulling through
   * the correct error message if applicable.
   */
  public function validate($key, $data){
    // Set up variable to hold error code.
    $error = null;

    // Make sure the controller has set what are we are in.  This should be automatic.
    if($this->area){

      /**
       * Switch the rules depending on the API call.
       */
      switch($this->area){

        /**
         * Fundraiser search API validation rules.
         */
        case 'search':
          switch($key){

            // Validation for surname.
            case 'surname':
              if(strlen($data) <= 3 && !empty($data)){
                $error = '001.02.010';
                $replace = array(
                  array('{{field}}'),
                  array($key),
                );
              }
              break;

            // Validation for forename.
            case 'forename':
              if(strlen($data) <= 3 && !empty($data)){
                $error = '001.02.010';
                $replace = array(
                  array('{{field}}'),
                  array($key),
                );
              }
              break;

            // Validation to see if any search criteria is present.
            case 'criteria':
              if((!$data['surname'] && !$data['forename']) || (empty($data['surname']) && empty($data['forename']))) {
                $error = '001.02.012';
              }
              break;

            // Validation to see if api_key is there.
            case 'api_key':
              if(!$data || empty($data)) {
                $error = '001.00.004';
              }
              break;

            // When no custom rules, invalid value.
            default:
              $error = '001.00.001';
          }
          break;
      }
    }

    // If an error code exists.
    if($error){
      // Check if there are any replacement tokens.
      if($replace){
        // Replace the tokens with the correct data.
        $message = str_replace($replace[0], $replace[1], $this->Error->errors[$error]['Explanation']);
      } else {
        $message = $this->Error->errors[$error]['Explanation'];
      }
      // Set the error code and messages as determined above.
      $this->errors[] = array(
        'errorCode' => $error,
        'errorMessage' => $message
      );
      return false;
    } else {
      return true;
    }
  }
}

